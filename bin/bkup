#!/bin/bash

SSH_CTL=/tmp/oslic.22.bass6
SSHFS_REMOTE=bass6@oslic:/g/g0/bass6
SSHFS_OPTS="-o allow_other -o ControlPath=$SSH_CTL"

MNTPT=/mnt/oslic
SNAPSEND=/home/bass6/snapsend
DATASET=rpool/bass6home
GPGRECIP=bass6@llnl.gov
DESTDIR=$MNTPT/desktop_backup
PREFIX=zfs-auto-snap_daily
CMD="perl $SNAPSEND -d $DATASET -r $GPGRECIP -s $DESTDIR -p $PREFIX"

export GNUPGHOME=/home/bass6/.gnupg

if ! df /mnt/oslic | grep -q 'bass6@oslic:/g/g0/bass6' ; then
	if [ ! -S $SSH_CTL ] ; then
		echo "Backup failed: $SSH_CTL doesn't exist."
		exit 1
	fi
	if [ ! -d $MNTPT ] ; then
		if ! mkdir $MNTPT ; then
			echo "Backup failed: unable to mkdir $MNTPT."
			exit 1
		fi
	fi
	if ! sshfs $SSHFS_OPTS $SSHFS_REMOTE $MNTPT ; then
		echo "Backup failed: unable to mount $SSHFS_REMOTE."
		umount $MNTPT
		exit 1
	fi
fi

$CMD
if [ $? -ne 0 ] ; then
	echo "Backup failed: '$CMD' returned non-zero."
	exit 1
fi

echo Success!
exit 0
